{{define "search"}}

{{/* 
  IMPORTANT IMPLEMENTATION NOTES:
  - DO NOT USE HTMX for any data requests on this page
  - Use ONLY JSON API endpoints with fetch/Alpine.js for all data operations
  - This page is part of migration away from HTMX to pure JSON API architecture
  - All search functionality must use JSON API endpoints with proper fetch requests
  - Maintain this architecture for any future enhancements to the search functionality
*/}}

<div class="col-span-12 space-y-4" x-data="searchUI">
    <!-- Search Form -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
            <h2 class="card-title">Search Filters</h2>
            
            <form class="mt-4 space-y-6" @submit.prevent="submitSearch()">
                <!-- Basic Filters -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Species Search -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Species</span>
                        </label>
                        <div class="flex w-full">
                            <input 
                                type="text" 
                                x-model="speciesSearchTerm" 
                                placeholder="Search by species name" 
                                class="input input-bordered w-full"
                            />
                        </div>
                        <label class="label">
                            <span class="label-text-alt">Enter common or scientific name</span>
                        </label>
                    </div>
                    
                    <!-- Date Range -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Date Range</span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <div>
                                <input 
                                    type="date" 
                                    x-model="dateRange.start" 
                                    class="input input-bordered w-full" 
                                    placeholder="Start date"
                                />
                                <label class="label">
                                    <span class="label-text-alt">Start date</span>
                                </label>
                            </div>
                            <div>
                                <input 
                                    type="date" 
                                    x-model="dateRange.end" 
                                    class="input input-bordered w-full" 
                                    placeholder="End date"
                                />
                                <label class="label">
                                    <span class="label-text-alt">End date</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Filters Toggle -->
                <div class="flex items-center justify-between">
                    <button 
                        type="button"
                        class="btn btn-sm btn-ghost" 
                        @click="advancedFilters = !advancedFilters"
                    >
                        <span x-text="advancedFilters ? 'Hide Advanced Filters' : 'Show Advanced Filters'"></span>
                        <svg 
                            xmlns="http://www.w3.org/2000/svg" 
                            class="h-4 w-4 transition-transform" 
                            :class="{'rotate-180': advancedFilters}"
                            fill="none" 
                            viewBox="0 0 24 24" 
                            stroke="currentColor"
                        >
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
                
                <!-- Advanced Filters Section -->
                <div x-show="advancedFilters" x-transition class="space-y-6">
                    <!-- Confidence Range -->
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Confidence Range (%)</span>
                            <span class="label-text-alt" x-bind:text="confidenceRange.min + '% - ' + confidenceRange.max + '%'"></span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    x-model.number="confidenceRange.min" 
                                    class="range range-xs" 
                                />
                                <div class="flex justify-between text-xs px-2">
                                    <span>0%</span>
                                    <span x-text="confidenceRange.min + '%'"></span>
                                    <span>100%</span>
                                </div>
                            </div>
                            <div>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    x-model.number="confidenceRange.max" 
                                    class="range range-xs" 
                                />
                                <div class="flex justify-between text-xs px-2">
                                    <span>0%</span>
                                    <span x-text="confidenceRange.max + '%'"></span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                        <!-- Confidence error message -->
                        <div x-show="confidenceError" class="text-error text-sm mt-1" x-text="confidenceError"></div>
                    </div>
                    
                    <!-- Status Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Verified Status -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Verified Status</span>
                            </label>
                            <select x-model="verifiedStatus" class="select select-bordered w-full">
                                <option value="any">Any Status</option>
                                <option value="verified">Verified Only</option>
                                <option value="unverified">Unverified Only</option>
                            </select>
                        </div>
                        
                        <!-- Locked Status -->
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Locked Status</span>
                            </label>
                            <select x-model="lockedStatus" class="select select-bordered w-full">
                                <option value="any">Any Status</option>
                                <option value="locked">Locked Only</option>
                                <option value="unlocked">Unlocked Only</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Form Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-end">
                    <button 
                        type="button" 
                        class="btn btn-ghost" 
                        @click="resetForm()"
                    >
                        Reset
                    </button>
                    <button 
                        type="submit" 
                        class="btn btn-primary"
                        :disabled="isLoading"
                    >
                        <template x-if="isLoading">
                            <span class="loading loading-spinner loading-sm mr-2"></span>
                        </template>
                        <template x-if="!isLoading">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                            </svg>
                        </template>
                        Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Area -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body">
            <div class="flex items-center justify-between">
                <h2 class="card-title">Search Results</h2>
                
                <!-- Results Count & Sorting -->
                <div x-show="formSubmitted" x-transition class="flex items-center gap-4">
                    <span class="text-sm text-base-content/70" x-text="totalResults + ' result' + (totalResults !== 1 ? 's' : '')"></span>
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-sm btn-outline">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20">
                                <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"/>
                            </svg>
                            Sort
                        </div>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                            <li><a @click="changeSort('date_desc')">Date (Newest First)</a></li>
                            <li><a @click="changeSort('date_asc')">Date (Oldest First)</a></li>
                            <li><a @click="changeSort('species_asc')">Species (A-Z)</a></li>
                            <li><a @click="changeSort('confidence_desc')">Confidence (High-Low)</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Error message -->
            <div x-show="errorMessage" class="alert alert-error mt-4">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span x-text="errorMessage"></span>
            </div>
            
            <!-- When no search performed yet -->
            <div x-show="!formSubmitted" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
                </svg>
                <p class="text-base-content/50 text-center mt-4">No search performed yet</p>
                <p class="text-base-content/50 text-center text-sm">Use the search filters above to find bird detections</p>
            </div>
            
            <!-- Loading indicator -->
            <div x-show="isLoading && formSubmitted" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]">
                <span class="loading loading-spinner loading-lg text-primary"></span>
                <p class="text-base-content/50 text-center mt-4">Loading results...</p>
            </div>
            
            <!-- Search results table - only visible when search performed -->
            <div x-show="formSubmitted && !isLoading && results.length > 0" x-transition class="overflow-x-auto mt-4">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Species</th>
                            <th>Confidence</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Loop through results -->
                        <template x-for="(result, index) in results" :key="result.id">
                            <tbody class="contents"> <!-- Wrapper for main and expanded row -->
                                <!-- Main row -->
                                <tr :class="index % 2 === 0 ? 'bg-base-100' : 'bg-base-200'">
                                    <td x-text="formatDate(result.timestamp)"></td>
                                    <td>
                                        <div class="flex items-center gap-2">
                                            <div>
                                                <div class="font-bold" x-text="result.commonName || 'Unknown'"></div>
                                                <div class="text-xs opacity-50" x-text="result.scientificName || ''"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex items-center">
                                            <div class="flex items-center gap-2 w-full">
                                                <div class="w-16 h-4 rounded-full overflow-hidden bg-base-200">
                                                    <div class="h-full"
                                                         :class="{
                                                            'bg-success': result.confidence >= 0.8,
                                                            'bg-warning': result.confidence >= 0.4 && result.confidence < 0.8,
                                                            'bg-error': result.confidence < 0.4
                                                         }"
                                                         :style="'width: ' + (result.confidence * 100) + '%'"></div>
                                                </div>
                                                <span class="ml-1 font-semibold" x-text="(result.confidence * 100).toFixed(0) + '%'"></span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex gap-1 flex-wrap">
                                            <div class="status-badge" :class="{
                                                'correct': result.verified === 'correct',
                                                'false': result.verified === 'false_positive',
                                                'unverified': result.verified !== 'correct' && result.verified !== 'false_positive'
                                            }" x-text="result.verified === 'correct' ? 'Verified' : (result.verified === 'false_positive' ? 'False' : 'Unverified')"></div>
                                            <div class="status-badge" :class="{'locked': result.locked, 'unverified': !result.locked}"
                                                 x-text="result.locked ? 'Locked' : 'Unlocked'"></div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex gap-1">
                                            <button class="btn btn-xs btn-square" @click.prevent="playAudioFromRow(result.id)"
                                                    :disabled="!result.hasAudio">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                                                </svg>
                                            </button>
                                            <button class="btn btn-xs btn-square" @click="window.location.href = `/api/v2/detections/${result.id}`">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                </svg>
                                            </button>
                                            <button class="btn btn-xs btn-square expand-btn"
                                                    @click.prevent="toggleExpand(result.id)"
                                                    :data-id="result.id">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" :class="{'rotate-180': isExpanded(result.id)}">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Expanded row - associated with the result above -->
                                <tr x-show="isExpanded(result.id)" class="expanded-row">
                                    <td colspan="5" class="p-0 border-t-0">
                                        <div class="p-4 bg-base-200">
                                            <!-- Expanded content -->
                                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                <!-- Weather Information Container -->
                                                <div class="bg-base-200 rounded-box p-4" x-data="{
                                                    weather: null,
                                                    loading: true,
                                                    error: null,
                                                    
                                                    init() {
                                                        this.fetchWeatherInfo(result.id);
                                                    },
                                                    
                                                    fetchWeatherInfo(resultId) {
                                                        fetch(`/api/v2/weather/detection/${resultId}`)
                                                            .then(response => {
                                                                if (!response.ok) {
                                                                    throw new Error('Weather data not available');
                                                                }
                                                                return response.json();
                                                            })
                                                            .then(data => {
                                                                this.weather = data;
                                                                this.loading = false;
                                                            })
                                                            .catch(err => {
                                                                console.error('Error fetching weather data:', err);
                                                                this.error = err.message;
                                                                this.loading = false;
                                                            });
                                                    }
                                                }">
                                                    <h3 class="text-lg font-semibold text-base-content mb-3">Weather Information</h3>
                                                    
                                                    <!-- Loading state -->
                                                    <div x-show="loading" class="py-4 flex justify-center">
                                                        <svg class="animate-spin h-6 w-6 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
                                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
                                                        </svg>
                                                    </div>
                                                    
                                                    <!-- Error state -->
                                                    <div x-show="!loading && error" class="py-4">
                                                        <div class="text-error flex items-center">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                                                                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                            </svg>
                                                            <span x-text="error"></span>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Weather data (when available) -->
                                                    <div x-show="!loading && !error && weather" class="grid grid-cols-2 gap-2 text-sm">
                                                        <div class="flex items-center">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15a4 4 0 004 4h9a5 5 0 10-.1-9.999 5.002 5.002 0 10-9.78 2.096A4.001 4.001 0 003 15z" />
                                                            </svg>
                                                            <div>
                                                                <div class="text-base-content/70">Temperature</div>
                                                                <div class="font-medium" x-text="weather?.temperature ? `${weather.temperature}°C` : 'N/A'"></div>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                                            </svg>
                                                            <div>
                                                                <div class="text-base-content/70">Weather</div>
                                                                <div class="font-medium" x-text="weather?.condition || 'N/A'"></div>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z" />
                                                            </svg>
                                                            <div>
                                                                <div class="text-base-content/70">Wind</div>
                                                                <div class="font-medium" x-text="weather?.windSpeed ? `${weather.windSpeed} km/h` : 'N/A'"></div>
                                                            </div>
                                                        </div>
                                                        <div class="flex items-center">
                                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3.055 11H5a2 2 0 012 2v1a2 2 0 002 2 2 2 0 012 2v2.945M8 3.935V5.5A2.5 2.5 0 0010.5 8h.5a2 2 0 012 2 2 2 0 104 0 2 2 0 012-2h1.064M15 20.488V18a2 2 0 012-2h3.064M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                            </svg>
                                                            <div>
                                                                <div class="text-base-content/70">Humidity</div>
                                                                <div class="font-medium" x-text="weather?.humidity ? `${weather.humidity}%` : 'N/A'"></div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <!-- Audio Player Container -->
                                                <div class="bg-base-200 rounded-box p-4">
                                                    <h3 class="text-lg font-semibold mb-2">Audio Player</h3>
                                                    
                                                    <div class="audio-player-container relative">
                                                        <!-- Hidden audio element -->
                                                        <audio :id="'audio-' + result.id" class="hidden" :src="'/api/v2/audio/' + result.id"></audio>
                                                        
                                                        <!-- Spectrogram Image -->
                                                        <img :src="'/api/v2/spectrogram/' + result.id + '?width=400'" alt="Spectrogram" 
                                                            class="w-full rounded object-cover" />
                                                        
                                                        <!-- Play position indicator -->
                                                        <div :id="'position-indicator-' + result.id" class="absolute top-0 bottom-0 w-0.5 bg-primary pointer-events-none"
                                                            style="left: 0; transition: left 0.1s linear; opacity: 0;"></div>
                                                        
                                                        <!-- Audio controls overlay -->
                                                        <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-25 p-1 rounded-b-md">
                                                            <div class="flex items-center justify-between">
                                                                <button :id="'playPause-' + result.id" class="text-white p-1 rounded-full hover:bg-white hover:bg-opacity-20 flex-shrink-0">
                                                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                                                    </svg>
                                                                </button>
                                                                <div :id="'progress-' + result.id" class="flex-grow bg-gray-200 rounded-full h-1.5 mx-2 cursor-pointer">
                                                                    <div class="bg-primary h-1.5 rounded-full" style="width: 0%"></div>
                                                                </div>
                                                                <span :id="'currentTime-' + result.id" class="text-xs font-medium text-white flex-shrink-0">0:00</span>
                                                                <a :href="'/api/v2/audio/' + result.id" download class="text-white p-1 rounded-full hover:bg-white hover:bg-opacity-20 ml-2 flex-shrink-0">
                                                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                                                                    </svg>
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody> <!-- End wrapper -->
                        </template>
                    </tbody>
                </table>

            </div>
            
            <!-- Empty state - when search returns no results -->
            <div x-show="formSubmitted && !isLoading && results.length === 0 && !errorMessage" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p class="mt-2 text-base-content/70">No results found</p>
                <p class="text-sm text-base-content/50">Try adjusting your search filters</p>
            </div>
            
            <!-- Pagination - visible when results are available -->
            <div x-show="formSubmitted && !isLoading && totalPages > 1" class="flex justify-center mt-6">
                <div class="join">
                    <button class="join-item btn" @click="goToPage(currentPage - 1)" :disabled="currentPage <= 1">«</button>
                    <button class="join-item btn">Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span></button>
                    <button class="join-item btn" @click="goToPage(currentPage + 1)" :disabled="currentPage >= totalPages">»</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .status-badge {
        @apply px-2 py-0.5 rounded-full text-xs font-medium;
    }
    .status-badge.correct {
        @apply bg-success/20 text-success;
    }
    .status-badge.false {
        @apply bg-error/20 text-error;
    }
    .status-badge.unverified {
        @apply bg-base-content/10 text-base-content/70;
    }
    .status-badge.locked {
        @apply bg-warning/20 text-warning;
    }
    
    /* IMPORTANT: Change to a more specific selector to avoid conflict */
    .initial-cloak[x-cloak] {
        display: none !important;
    }
    
    /* Highlight expanded rows for better visibility */
    .expanded-row {
        border-left: 4px solid #3b82f6;
    }
</style>

<script>
    document.addEventListener('alpine:init', () => {
        Alpine.data('searchUI', () => ({
            speciesSearchTerm: '',
            dateRange: {
                start: '',
                end: ''
            },
            confidenceRange: {
                min: 0,
                max: 100
            },
            verifiedStatus: 'any',
            lockedStatus: 'any',
            formSubmitted: false,
            advancedFilters: false,
            isLoading: false,
            currentPage: 1,
            totalPages: 1,
            results: [],
            totalResults: 0,
            sortBy: 'date_desc',
            errorMessage: '',
            expanded: {},
            confidenceError: '',
            initializedPlayers: {}, // Track initialized players
            
            // Form validation methods
            validateForm() {
                // Basic validation logic
                this.confidenceError = ''; // Reset error
                if (this.confidenceRange.min > this.confidenceRange.max) {
                    this.confidenceError = 'Minimum confidence cannot be greater than maximum confidence.';
                    return false;
                }
                return true;
            },
            
            // Form submission
            async submitSearch(page = 1) {
                if (!this.validateForm()) return;
                
                this.isLoading = true;
                this.errorMessage = '';
                this.currentPage = page;
                this.expanded = {}; // Reset expanded state when loading new results
                
                try {
                    const response = await fetch('/api/v2/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': document.querySelector('meta[name=\'csrf-token\']').content
                        },
                        body: JSON.stringify({
                            species: this.speciesSearchTerm,
                            dateStart: this.dateRange.start,
                            dateEnd: this.dateRange.end,
                            confidenceMin: this.confidenceRange.min / 100,
                            confidenceMax: this.confidenceRange.max / 100,
                            verifiedStatus: this.verifiedStatus,
                            lockedStatus: this.lockedStatus,
                            page: this.currentPage,
                            sortBy: this.sortBy
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.results = data.results || [];
                    this.totalResults = data.total || 0;
                    this.totalPages = data.pages || 1;
                    this.formSubmitted = true;
                } catch (error) {
                    console.error('Search error:', error);
                    this.errorMessage = `Search failed: ${error.message}`;
                    this.results = [];
                } finally {
                    this.isLoading = false;
                }
            },
            
            // Reset form
            resetForm() {
                this.speciesSearchTerm = '';
                this.dateRange.start = '';
                this.dateRange.end = '';
                this.confidenceRange.min = 0;
                this.confidenceRange.max = 100;
                this.verifiedStatus = 'any';
                this.lockedStatus = 'any';
                this.formSubmitted = false;
                this.results = [];
                this.errorMessage = '';
                this.expanded = {};
            },
            
            // Format date for display
            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleString();
            },
            
            // Handle pagination
            goToPage(page) {
                if (page < 1 || page > this.totalPages) return;
                this.submitSearch(page);
            },
            
            // Handle sorting
            changeSort(sortOption) {
                this.sortBy = sortOption;
                this.submitSearch(1);
            },
            
            // Function to toggle expand state of a row
            toggleExpand(recordId) {
                console.log('Toggle expand clicked for ID:', recordId);
                
                // Pause audio if collapsing and currently playing
                if (this.expanded[recordId]) { // Check if it was expanded before toggling
                    const audioElement = document.getElementById(`audio-${recordId}`);
                    if (audioElement && !audioElement.paused) {
                        audioElement.pause();
                        console.log('Paused audio for collapsed row:', recordId);
                    }
                }

                // Use the spread operator for reactivity
                this.expanded = {
                    ...this.expanded, 
                    [recordId]: !this.expanded[recordId]
                };
                
                console.log('New expanded state:', JSON.stringify(this.expanded));
                
                // Force render on next tick
                this.$nextTick(() => {
                    // Initialize audio player when expanded
                    if (this.expanded[recordId]) {
                        this.initAudioPlayer(recordId);
                    }
                });
            },
            
            isExpanded(recordId) {
                return Boolean(this.expanded[recordId]);
            },
            
            // New method to initialize audio player
            initAudioPlayer(recordId) {
                console.log('Initializing audio player for ID:', recordId);
                
                // Prevent re-initialization
                if (this.initializedPlayers[recordId]) {
                    console.log('Audio player already initialized for ID:', recordId);
                    return;
                }
                
                const audioElement = document.getElementById(`audio-${recordId}`);
                const playPauseButton = document.getElementById(`playPause-${recordId}`);
                const progressBar = document.getElementById(`progress-${recordId}`);
                const progressIndicator = progressBar.querySelector('div');
                const currentTimeDisplay = document.getElementById(`currentTime-${recordId}`);
                const positionIndicator = document.getElementById(`position-indicator-${recordId}`);
                
                if (!audioElement || !playPauseButton || !progressBar || !currentTimeDisplay) {
                    console.error('Audio player elements not found');
                    return;
                }
                
                // Format time function
                const formatTime = (seconds) => {
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = Math.floor(seconds % 60);
                    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                };
                
                // Update progress function
                const updateProgress = () => {
                    if (!audioElement.duration) { return; }        // wait until metadata ready
                    const percent = (audioElement.currentTime / audioElement.duration) * 100;
                    progressIndicator.style.width = `${percent}%`;
                    currentTimeDisplay.textContent = formatTime(audioElement.currentTime);
                    
                    // Update position indicator
                    positionIndicator.style.left = `${percent}%`;
                    positionIndicator.style.opacity = 
                        (audioElement.currentTime === 0 || audioElement.currentTime === audioElement.duration) ? '0' : '0.7';
                };
                
                // Interval for updating progress
                let updateInterval;
                
                // Play/pause toggle
                const togglePlay = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (audioElement.paused) {
                        audioElement.play();
                    } else {
                        audioElement.pause();
                    }
                };
                
                // Add play button click handler
                playPauseButton.addEventListener('click', togglePlay);
                
                // Play event
                audioElement.addEventListener('play', () => {
                    playPauseButton.innerHTML = `
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    `;
                    updateInterval = setInterval(updateProgress, 100);
                });
                
                // Pause event
                audioElement.addEventListener('pause', () => {
                    playPauseButton.innerHTML = `
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    `;
                    clearInterval(updateInterval);
                });
                
                // End event
                audioElement.addEventListener('ended', () => {
                    clearInterval(updateInterval);
                    positionIndicator.style.opacity = '0';
                });
                
                // Add loadedmetadata event to update progress bar immediately when metadata is available
                audioElement.addEventListener('loadedmetadata', () => {
                    updateProgress();
                });
                
                // Progress bar click for seeking
                progressBar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const rect = progressBar.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    audioElement.currentTime = pos * audioElement.duration;
                    updateProgress();
                });
                
                // Seeking functionality for the spectrogram
                const spectrogramContainer = positionIndicator.closest('.audio-player-container');
                spectrogramContainer.addEventListener('click', (e) => {
                    // Only handle clicks directly on the spectrogram, not on controls
                    if (e.target === spectrogramContainer || e.target.tagName === 'IMG') {
                        const rect = spectrogramContainer.getBoundingClientRect();
                        const pos = (e.clientX - rect.left) / rect.width;
                        audioElement.currentTime = pos * audioElement.duration;
                        updateProgress();
                    }
                });
                
                // Initial update
                updateProgress();
                
                // Mark as initialized
                this.initializedPlayers[recordId] = true;
                console.log('Audio player successfully initialized for ID:', recordId);
            },

            // Updated method to play/pause audio from the main row button
            playAudioFromRow(recordId) {
                console.log('Play/Pause audio from row requested for:', recordId);

                if (this.isExpanded(recordId)) {
                    // Row is already expanded, toggle play/pause
                    console.log('Row already expanded, toggling play/pause for:', recordId);
                    const audioElement = document.getElementById(`audio-${recordId}`);
                    if (audioElement) {
                        if (!audioElement.paused) {
                            audioElement.pause();
                            console.log('Paused audio via row button:', recordId);
                        } else {
                            // Ensure player is initialized before playing again
                            this.initAudioPlayer(recordId);
                            audioElement.play().catch(e => console.error('Error playing audio:', e));
                            console.log('Played audio via row button:', recordId);
                        }
                    } else {
                        // Should ideally not happen if expanded, but handle it
                        console.warn('Audio element not found even though row is expanded:', recordId);
                        // Attempt to initialize and play
                        this.$nextTick(() => {
                            this.initAudioPlayer(recordId);
                            const newAudioElement = document.getElementById(`audio-${recordId}`);
                            if (newAudioElement) {
                                newAudioElement.play().catch(e => console.error('Error playing audio:', e));
                            }
                        });
                    }
                } else {
                    // Row not expanded, expand first and then play
                    console.log('Row not expanded, expanding and playing:', recordId);
                    this.toggleExpand(recordId); // This will call initAudioPlayer internally

                    // Use nextTick to ensure DOM update and player initialization before playing
                    this.$nextTick(() => {
                         const audioElement = document.getElementById(`audio-${recordId}`);
                         if (audioElement) {
                             // Small delay might be needed if initAudioPlayer is slow or async inside toggleExpand
                             setTimeout(() => { 
                                audioElement.play().catch(e => {
                                    console.error('Error playing audio after expand:', e);
                                });
                                console.log('Attempted to play audio after expand for:', recordId);
                             }, 50); // Adjust delay if necessary
                         } else {
                             console.error('Audio element not found after expand for:', recordId);
                         }
                    });
                }
            }
        }));
    });
    
    // Add this code to help debug click events
    document.addEventListener('DOMContentLoaded', () => {
        // Add global click listener to debug expand buttons
        document.addEventListener('click', (e) => {
            if (e.target.closest('.expand-btn')) {
                console.log('Expand button clicked via event delegation');
            }
        });
    });
</script>

{{end}}