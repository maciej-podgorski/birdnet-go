{{define "search"}}

{{/* 
  IMPORTANT IMPLEMENTATION NOTES:
  - DO NOT USE HTMX for any data requests on this page
  - Use ONLY JSON API endpoints with fetch/Alpine.js for all data operations
  - This page is part of migration away from HTMX to pure JSON API architecture
  - All search functionality must use JSON API endpoints with proper fetch requests
  - Maintain this architecture for any future enhancements to the search functionality
*/}}

<div class="col-span-12 space-y-4" x-data="searchUI" role="region" aria-label="Bird Detection Search">
    <!-- Search Form -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-4 m-2">
            <h2 class="card-title" id="search-filters-heading">Search Filters</h2>
            
            <form id="searchForm" class="space-y-4" @submit.prevent="submitSearch(1)" x-ref="searchForm" aria-labelledby="search-filters-heading">
                <!-- Basic Search Fields -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Species -->
                    <div class="form-control">
                        {{template "textField" dict 
                          "id" "species" 
                          "label" "Species" 
                          "model" "speciesSearchTerm" 
                          "placeholder" "Enter species name"
                          "tooltip" "Enter full or partial species name (not case sensitive)"
                        }}
                    </div>
                    
                    <!-- Date Range -->
                    <div class="form-control">
                        <label class="label" id="dateRangeLabel">
                            <span class="label-text">Date Range</span>
                            <span class="help-icon" 
                                @mouseenter="showTooltip = 'dateRange'"
                                @mouseleave="showTooltip = null"
                                @focus="showTooltip = 'dateRange'"
                                @blur="showTooltip = null"
                                role="button"
                                tabindex="0"
                                aria-label="Help for Date Range"
                                aria-controls="dateRangeTooltip">â“˜</span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2" role="group" aria-labelledby="dateRangeLabel">
                            {{template "dateInput" dict 
                              "id" "startDate" 
                              "model" "dateRange.start" 
                              "placeholder" "Start Date"
                              "altLabel" "From"
                              "tooltip" "Start date for search range (inclusive)"
                            }}
                            {{template "dateInput" dict 
                              "id" "endDate" 
                              "model" "dateRange.end" 
                              "placeholder" "End Date"
                              "altLabel" "To"
                              "tooltip" "End date for search range (inclusive)"
                            }}
                        </div>
                        <div x-show="showTooltip === 'dateRange'" 
                             x-cloak 
                             :aria-hidden="showTooltip !== 'dateRange'"
                             class="tooltip"
                             id="dateRangeTooltip"
                             role="tooltip">
                            Filter detections by date range (leave empty for all dates)
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Filters Toggle -->
                <div class="flex items-center justify-between">
                    <button 
                        type="button"
                        class="btn btn-sm btn-ghost" 
                        @click="advancedFilters = !advancedFilters"
                        aria-expanded="advancedFilters"
                        aria-controls="advancedFiltersSection"
                    >
                        <span x-text="advancedFilters ? 'Hide Advanced Filters' : 'Show Advanced Filters'"></span>
                        <svg 
                            xmlns="http://www.w3.org/2000/svg" 
                            class="h-4 w-4 transition-transform" 
                            :class="{'rotate-180': advancedFilters}"
                            fill="none" 
                            viewBox="0 0 24 24" 
                            stroke="currentColor"
                            aria-hidden="true"
                        >
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
                
                <!-- Advanced Filters Section -->
                <div x-show="advancedFilters" x-transition class="space-y-2" id="advancedFiltersSection">
                    <!-- Confidence Range -->
                    <div class="form-control">
                        <label class="label" id="confidenceRangeLabel">
                            <span class="label-text">Confidence Range (%)</span>
                            <span class="label-text-alt" x-bind:text="confidenceRange.min + '% - ' + confidenceRange.max + '%'"></span>
                        </label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6" role="group" aria-labelledby="confidenceRangeLabel">
                            <div>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    x-model.number="confidenceRange.min" 
                                    class="range range-xs" 
                                    aria-label="Minimum confidence percentage"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                    :aria-valuenow="confidenceRange.min"
                                    :aria-valuetext="confidenceRange.min + '%'"
                                />
                                <div class="flex justify-between text-xs px-2">
                                    <span>0%</span>
                                    <span x-text="confidenceRange.min + '%'"></span>
                                    <span>100%</span>
                                </div>
                            </div>
                            <div>
                                <input 
                                    type="range" 
                                    min="0" 
                                    max="100" 
                                    x-model.number="confidenceRange.max" 
                                    class="range range-xs" 
                                    aria-label="Maximum confidence percentage"
                                    aria-valuemin="0"
                                    aria-valuemax="100"
                                    :aria-valuenow="confidenceRange.max"
                                    :aria-valuetext="confidenceRange.max + '%'"
                                />
                                <div class="flex justify-between text-xs px-2">
                                    <span>0%</span>
                                    <span x-text="confidenceRange.max + '%'"></span>
                                    <span>100%</span>
                                </div>
                            </div>
                        </div>
                        <!-- Confidence error message -->
                        <div x-show="confidenceError" class="text-error text-sm mt-1" role="alert" x-text="confidenceError"></div>
                    </div>
                    
                    <!-- Status & Time of Day Filters -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <!-- Verified Status -->
                        {{template "selectField" dict 
                            "id" "verifiedStatusFilter" 
                            "label" "Verified Status" 
                            "model" "verifiedStatus" 
                            "options" (dict "any" "Any Status" "verified" "Verified Only" "unverified" "Unverified Only") 
                            "tooltip" "Filter detections based on their verification status."
                        }}

                        <!-- Locked Status (Restored) -->
                        {{template "selectField" dict 
                            "id" "lockedStatusFilter" 
                            "label" "Locked Status" 
                            "model" "lockedStatus" 
                            "options" (dict "any" "Any Status" "locked" "Locked Only" "unlocked" "Unlocked Only") 
                            "tooltip" "Filter detections based on whether they are locked (preventing changes)."
                        }}

                        <!-- Time of Day -->
                        {{template "selectField" dict 
                            "id" "timeOfDayFilter" 
                            "label" "Time of Day" 
                            "model" "timeOfDayFilter" 
                            "options" (dict "any" "Any Time" "day" "Day Only" "night" "Night Only" "sunrise" "Sunrise +/- 30min" "sunset" "Sunset +/- 30min") 
                            "tooltip" "Filter detections based on the calculated time of day (Day, Night, Sunrise, Sunset)."
                        }}
                    </div>
                </div>
                
                <!-- Form Action Buttons -->
                <div class="flex flex-col sm:flex-row gap-4 justify-end">
                    <button 
                        type="button" 
                        class="btn btn-ghost" 
                        @click="resetForm()"
                        aria-label="Reset all search filters"
                    >
                        Reset
                    </button>
                    <button 
                        type="submit" 
                        class="btn btn-primary"
                        :disabled="isLoading"
                        aria-label="Search for bird detections"
                    >
                        <template x-if="isLoading">
                            <span class="loading loading-spinner loading-sm mr-2" aria-hidden="true"></span>
                        </template>
                        <template x-if="!isLoading">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd"></path>
                            </svg>
                        </template>
                        Search
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Area -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body p-4 m-2">
            <div class="flex items-center justify-between">
                <h2 class="card-title" id="search-results-heading">Search Results</h2>
                
                <!-- Results Count & Sorting -->
                <div x-show="formSubmitted" x-transition class="flex items-center gap-4">
                    <span class="text-sm text-base-content/70" x-text="totalResults + ' result' + (totalResults !== 1 ? 's' : '')" aria-live="polite"></span>
                    <div class="dropdown dropdown-end">
                        <div tabindex="0" role="button" class="btn btn-sm btn-outline" aria-haspopup="true" aria-expanded="false" aria-label="Sort results">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" aria-hidden="true">
                                <path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z"/>
                            </svg>
                            Sort
                        </div>
                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52" role="menu">
                            <li role="menuitem"><a @click="changeSort('date_desc')">Date (Newest First)</a></li>
                            <li role="menuitem"><a @click="changeSort('date_asc')">Date (Oldest First)</a></li>
                            <li role="menuitem"><a @click="changeSort('species_asc')">Species (A-Z)</a></li>
                            <li role="menuitem"><a @click="changeSort('confidence_desc')">Confidence (High-Low)</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Error message -->
            <div x-show="errorMessage" class="alert alert-error mt-4" role="alert">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <span x-text="errorMessage"></span>
            </div>
            
            <!-- When no search performed yet -->
            <div x-show="!formSubmitted" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]" aria-labelledby="search-results-heading">
                <svg xmlns="http://www.w3.org/2000/svg" class="w-16 h-16 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z"/>
                </svg>
                <p class="text-base-content/50 text-center mt-4">No search performed yet</p>
                <p class="text-base-content/50 text-center text-sm">Use the search filters above to find bird detections</p>
            </div>
            
            <!-- Loading indicator -->
            <div x-show="isLoading && formSubmitted" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]" aria-live="polite" aria-busy="true">
                <span class="loading loading-spinner loading-lg text-primary" aria-hidden="true"></span>
                <p class="text-base-content/50 text-center mt-4">Loading results...</p>
            </div>
            
            <!-- Search results table - only visible when search performed -->
            <div x-show="formSubmitted && !isLoading && results.length > 0" x-transition class="overflow-x-auto mt-4" aria-labelledby="search-results-heading">
                <table class="table w-full">
                    <thead>
                        <tr>
                            <th scope="col">Date & Time</th>
                            <th scope="col">Time of Day</th>
                            <th scope="col">Species</th>
                            <th scope="col">Confidence</th>
                            <th scope="col">Status</th>
                            <th scope="col">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Loop through results -->
                        <template x-for="(result, index) in results" :key="result.id">
                            <tbody class="contents"> <!-- Wrapper for main and expanded row -->
                                <!-- Main row -->
                                <tr :class="index % 2 === 0 ? 'bg-base-100' : 'bg-base-200'">
                                    <td x-text="formatDate(result.timestamp)"></td>
                                    <td>
                                        <div class="flex items-center">
                                            <!-- Time of Day icons and text -->
                                            <template x-if="result.timeOfDay === 'day'">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                                </svg>
                                            </template>
                                            <template x-if="result.timeOfDay === 'night'">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                                                </svg>
                                            </template>
                                            <template x-if="result.timeOfDay === 'sunrise'">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                    <path d="M17 18a5 5 0 0 0-10 0"></path>
                                                    <line x1="12" y1="2" x2="12" y2="9"></line>
                                                    <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line>
                                                    <line x1="1" y1="18" x2="3" y2="18"></line>
                                                    <line x1="21" y1="18" x2="23" y2="18"></line>
                                                    <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line>
                                                    <line x1="23" y1="22" x2="1" y2="22"></line>
                                                    <polyline points="8 6 12 2 16 6"></polyline>
                                                </svg>
                                            </template>
                                            <template x-if="result.timeOfDay === 'sunset'">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                    <path d="M17 18a5 5 0 0 0-10 0"></path>
                                                    <line x1="12" y1="9" x2="12" y2="2"></line>
                                                    <line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line>
                                                    <line x1="1" y1="18" x2="3" y2="18"></line>
                                                    <line x1="21" y1="18" x2="23" y2="18"></line>
                                                    <line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line>
                                                    <line x1="23" y1="22" x2="1" y2="22"></line>
                                                    <polyline points="16 5 12 9 8 5"></polyline>
                                                </svg>
                                            </template>
                                            <template x-if="result.timeOfDay !== 'day' && result.timeOfDay !== 'night' && result.timeOfDay !== 'sunrise' && result.timeOfDay !== 'sunset'">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            </template>
                                            <span x-text="result.timeOfDay || 'Unknown'"></span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex items-center gap-2">
                                            <div>
                                                <div class="font-bold" x-text="result.commonName || 'Unknown'"></div>
                                                <div class="text-xs opacity-50" x-text="result.scientificName || ''"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex items-center">
                                            <div class="flex items-center gap-2 w-full">
                                                <div class="w-16 h-4 rounded-full overflow-hidden bg-base-200" role="progressbar" :aria-valuenow="(result.confidence * 100).toFixed(0)" aria-valuemin="0" aria-valuemax="100" :aria-valuetext="(result.confidence * 100).toFixed(0) + '%'">
                                                    <div class="h-full"
                                                         :class="{
                                                            'bg-success': result.confidence >= 0.8,
                                                            'bg-warning': result.confidence >= 0.4 && result.confidence < 0.8,
                                                            'bg-error': result.confidence < 0.4
                                                         }"
                                                         :style="'width: ' + (result.confidence * 100) + '%'"></div>
                                                </div>
                                                <span class="ml-1 font-semibold" x-text="(result.confidence * 100).toFixed(0) + '%'"></span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex gap-1 flex-wrap">
                                            <div class="status-badge" :class="{
                                                'correct': result.verified === 'correct',
                                                'false': result.verified === 'false_positive',
                                                'unverified': result.verified !== 'correct' && result.verified !== 'false_positive'
                                            }" x-text="result.verified === 'correct' ? 'Verified' : (result.verified === 'false_positive' ? 'False' : 'Unverified')"></div>
                                            <div class="status-badge" :class="{'locked': result.locked, 'unverified': !result.locked}"
                                                 x-text="result.locked ? 'Locked' : 'Unlocked'"></div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="flex gap-1">
                                            <button class="btn btn-xs btn-square" 
                                                    @click.prevent="playAudioFromRow(result.id)"
                                                    :disabled="!result.hasAudio"
                                                    :aria-label="'Play audio for ' + (result.commonName || 'Unknown species')"
                                                    aria-pressed="false">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3"/>
                                                </svg>
                                            </button>
                                            <button class="btn btn-xs btn-square" 
                                                    @click="window.location.href = `/api/v2/detections/${result.id}`"
                                                    :aria-label="'View details for ' + (result.commonName || 'Unknown species')">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                </svg>
                                            </button>
                                            <button class="btn btn-xs btn-square expand-btn"
                                                    @click.prevent="toggleExpand(result.id)"
                                                    :data-id="result.id"
                                                    :aria-label="(isExpanded(result.id) ? 'Collapse' : 'Expand') + ' details for ' + (result.commonName || 'Unknown species')"
                                                    :aria-expanded="isExpanded(result.id)"
                                                    :aria-controls="'expanded-row-' + result.id">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" :class="{'rotate-180': isExpanded(result.id)}" aria-hidden="true">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                                </svg>
                                            </button>
                                        </div>
                                    </td>
                                </tr>

                                <!-- Expanded row - associated with the result above -->
                                <tr x-show="isExpanded(result.id)" class="expanded-row" :id="'expanded-row-' + result.id">
                                    <td colspan="6" class="p-0 border-t-0">
                                        <div class="p-4 bg-base-200">
                                            <!-- Expanded content -->
                                            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
                                                <!-- Left column -->
                                                <div class="space-y-4">
                                                    <!-- Recording info -->
                                                    <div class="bg-base-300 p-3 rounded-md">
                                                        <h3 class="font-semibold text-base-content mb-2">Recording Details</h3>
                                                        <div class="grid grid-cols-2 gap-2 text-sm">
                                                            <div>
                                                                <p class="text-base-content/60">Date</p>
                                                                <p class="font-medium" x-text="formatDate(result.timestamp)"></p>
                                                            </div>
                                                            <div>
                                                                <p class="text-base-content/60">Time</p>
                                                                <p class="font-medium" x-text="formatTime(result.timestamp)"></p>
                                                            </div>
                                                            <div>
                                                                <p class="text-base-content/60">Location</p>
                                                                <p class="font-medium" x-text="result.location || 'Unknown'"></p>
                                                            </div>
                                                            <div>
                                                                <p class="text-base-content/60">Recording ID</p>
                                                                <p class="font-medium" x-text="result.id"></p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Audio Player -->
                                                    <div class="bg-base-300 p-3 rounded-md">
                                                        <h3 class="font-semibold text-base-content mb-2">Audio</h3>
                                                        <div x-show="!result.hasAudio" class="text-sm text-base-content/60">
                                                            No audio available for this detection
                                                        </div>
                                                        <div x-show="result.hasAudio" class="space-y-2">
                                                            <div class="flex items-center gap-2">
                                                                <button 
                                                                    @click.prevent="playAudioFromRow(result.id)"
                                                                    class="btn btn-sm btn-circle"
                                                                    :class="{'btn-primary': isCurrentPlaying(result.id)}"
                                                                    aria-label="Play or pause audio"
                                                                    :aria-pressed="isCurrentPlaying(result.id)"
                                                                >
                                                                    <svg 
                                                                        x-show="!isCurrentPlaying(result.id)" 
                                                                        xmlns="http://www.w3.org/2000/svg" 
                                                                        class="h-4 w-4" 
                                                                        viewBox="0 0 20 20" 
                                                                        fill="currentColor"
                                                                        aria-hidden="true"
                                                                    >
                                                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664z" clip-rule="evenodd" />
                                                                    </svg>
                                                                    <svg 
                                                                        x-show="isCurrentPlaying(result.id)" 
                                                                        xmlns="http://www.w3.org/2000/svg" 
                                                                        class="h-4 w-4" 
                                                                        viewBox="0 0 20 20" 
                                                                        fill="currentColor"
                                                                        aria-hidden="true"
                                                                    >
                                                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zM7 8a1 1 0 012 0v4a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                                    </svg>
                                                                </button>
                                                                <div class="flex-1">
                                                                    <div 
                                                                        class="w-full bg-base-100 h-2 rounded-full overflow-hidden cursor-pointer relative"
                                                                        @click="seekAudio($event)"
                                                                        role="slider"
                                                                        aria-label="Audio playback position"
                                                                        aria-valuemin="0"
                                                                        aria-valuemax="100"
                                                                        :aria-valuenow="audioProgress"
                                                                        :aria-valuetext="audioProgress + '%'"
                                                                        tabindex="0"
                                                                        @keydown.left.prevent="seekBackward(5)"
                                                                        @keydown.right.prevent="seekForward(5)"
                                                                    >
                                                                        <div 
                                                                            class="absolute top-0 left-0 h-full bg-primary" 
                                                                            :style="'width:' + audioProgress + '%'"
                                                                            aria-hidden="true"
                                                                        ></div>
                                                                    </div>
                                                                </div>
                                                                <span class="text-xs" x-text="formatDuration(audioCurrentTime) + ' / ' + formatDuration(audioDuration)"></span>
                                                            </div>
                                                            <div class="flex gap-2 justify-end">
                                                                <a 
                                                                    :href="'/api/v2/detections/' + result.id + '/audio'" 
                                                                    download 
                                                                    class="btn btn-xs btn-ghost"
                                                                    aria-label="Download audio file"
                                                                >
                                                                    <svg 
                                                                        xmlns="http://www.w3.org/2000/svg" 
                                                                        class="h-4 w-4 mr-1" 
                                                                        fill="none" 
                                                                        viewBox="0 0 24 24" 
                                                                        stroke="currentColor"
                                                                        aria-hidden="true"
                                                                    >
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                                                                    </svg>
                                                                    Download
                                                                </a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <!-- Right column -->
                                                <div class="space-y-4">
                                                    <!-- Species info -->
                                                    <div class="bg-base-300 p-3 rounded-md">
                                                        <h3 class="font-semibold text-base-content mb-2">Species Information</h3>
                                                        <div class="flex flex-col gap-2">
                                                            <div>
                                                                <p class="text-base-content/60">Common Name</p>
                                                                <p class="font-medium" x-text="result.commonName || 'Unknown'"></p>
                                                            </div>
                                                            <div>
                                                                <p class="text-base-content/60">Scientific Name</p>
                                                                <p class="font-medium italic" x-text="result.scientificName || 'Unknown'"></p>
                                                            </div>
                                                            <div>
                                                                <p class="text-base-content/60">Confidence</p>
                                                                <div class="flex items-center gap-2">
                                                                    <div 
                                                                        class="w-24 h-3 rounded-full overflow-hidden bg-base-200"
                                                                        role="progressbar"
                                                                        :aria-valuenow="(result.confidence * 100).toFixed(0)"
                                                                        aria-valuemin="0"
                                                                        aria-valuemax="100"
                                                                        :aria-valuetext="(result.confidence * 100).toFixed(0) + '%'"
                                                                    >
                                                                        <div 
                                                                            class="h-full"
                                                                            :class="{
                                                                                'bg-success': result.confidence >= 0.8,
                                                                                'bg-warning': result.confidence >= 0.4 && result.confidence < 0.8,
                                                                                'bg-error': result.confidence < 0.4
                                                                            }"
                                                                            :style="'width: ' + (result.confidence * 100) + '%'"
                                                                        ></div>
                                                                    </div>
                                                                    <span class="font-semibold" x-text="(result.confidence * 100).toFixed(0) + '%'"></span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Actions -->
                                                    <div class="bg-base-300 p-3 rounded-md">
                                                        <h3 class="font-semibold text-base-content mb-2">Actions</h3>
                                                        <div class="flex flex-wrap gap-2">
                                                            <a 
                                                                :href="'/api/v2/detections/' + result.id" 
                                                                class="btn btn-sm btn-primary"
                                                                aria-label="View full details for this detection"
                                                            >
                                                                <svg 
                                                                    xmlns="http://www.w3.org/2000/svg" 
                                                                    class="h-4 w-4 mr-1" 
                                                                    fill="none" 
                                                                    viewBox="0 0 24 24" 
                                                                    stroke="currentColor"
                                                                    aria-hidden="true"
                                                                >
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                                                </svg>
                                                                View Details
                                                            </a>
                                                            
                                                            <button 
                                                                @click="verifyDetection(result.id, result.verified === 'correct' ? '' : 'correct')" 
                                                                class="btn btn-sm"
                                                                :class="{'btn-success': result.verified === 'correct', 'btn-outline': result.verified !== 'correct'}"
                                                                :disabled="result.locked || isUpdating"
                                                                aria-label="Mark as verified"
                                                                :aria-pressed="result.verified === 'correct'"
                                                            >
                                                                <svg 
                                                                    xmlns="http://www.w3.org/2000/svg" 
                                                                    class="h-4 w-4 mr-1" 
                                                                    fill="none" 
                                                                    viewBox="0 0 24 24" 
                                                                    stroke="currentColor"
                                                                    aria-hidden="true"
                                                                >
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                                </svg>
                                                                <span x-text="result.verified === 'correct' ? 'Verified' : 'Verify'"></span>
                                                            </button>
                                                            
                                                            <button 
                                                                @click="verifyDetection(result.id, result.verified === 'false_positive' ? '' : 'false_positive')" 
                                                                class="btn btn-sm"
                                                                :class="{'btn-error': result.verified === 'false_positive', 'btn-outline': result.verified !== 'false_positive'}"
                                                                :disabled="result.locked || isUpdating"
                                                                aria-label="Mark as false positive"
                                                                :aria-pressed="result.verified === 'false_positive'"
                                                            >
                                                                <svg 
                                                                    xmlns="http://www.w3.org/2000/svg" 
                                                                    class="h-4 w-4 mr-1" 
                                                                    fill="none" 
                                                                    viewBox="0 0 24 24" 
                                                                    stroke="currentColor"
                                                                    aria-hidden="true"
                                                                >
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                                </svg>
                                                                <span x-text="result.verified === 'false_positive' ? 'False' : 'Mark False'"></span>
                                                            </button>
                                                            
                                                            <button 
                                                                @click="toggleLock(result.id)" 
                                                                class="btn btn-sm"
                                                                :class="{'btn-neutral': result.locked, 'btn-outline': !result.locked}"
                                                                :disabled="isUpdating"
                                                                :aria-label="(result.locked ? 'Unlock' : 'Lock') + ' this detection'"
                                                                :aria-pressed="result.locked"
                                                            >
                                                                <svg 
                                                                    x-show="!result.locked" 
                                                                    xmlns="http://www.w3.org/2000/svg" 
                                                                    class="h-4 w-4 mr-1" 
                                                                    fill="none" 
                                                                    viewBox="0 0 24 24" 
                                                                    stroke="currentColor"
                                                                    aria-hidden="true"
                                                                >
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                                                                </svg>
                                                                <svg 
                                                                    x-show="result.locked" 
                                                                    xmlns="http://www.w3.org/2000/svg" 
                                                                    class="h-4 w-4 mr-1" 
                                                                    fill="none" 
                                                                    viewBox="0 0 24 24" 
                                                                    stroke="currentColor"
                                                                    aria-hidden="true"
                                                                >
                                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"/>
                                                                </svg>
                                                                <span x-text="result.locked ? 'Unlock' : 'Lock'"></span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </template>
                    </tbody>
                </table>

            </div>
            
            <!-- Empty state - when search returns no results -->
            <div x-show="formSubmitted && !isLoading && results.length === 0 && !errorMessage" class="mt-6 bg-base-200 rounded-lg p-4 flex flex-col items-center justify-center min-h-[200px]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-base-content/30" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <p class="mt-2 text-base-content/70">No results found</p>
                <p class="text-sm text-base-content/50">Try adjusting your search filters</p>
            </div>
            
            <!-- Pagination - visible when results are available -->
            <div x-show="formSubmitted && !isLoading && totalPages > 1" class="flex justify-center mt-6">
                <div class="join">
                    <button class="join-item btn" @click="goToPage(currentPage - 1)" :disabled="currentPage <= 1">Â«</button>
                    <button class="join-item btn">Page <span x-text="currentPage"></span> of <span x-text="totalPages"></span></button>
                    <button class="join-item btn" @click="goToPage(currentPage + 1)" :disabled="currentPage >= totalPages">Â»</button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .status-badge {
        @apply px-2 py-0.5 rounded-full text-xs font-medium;
    }
    .status-badge.correct {
        @apply bg-success/20 text-success;
    }
    .status-badge.false {
        @apply bg-error/20 text-error;
    }
    .status-badge.unverified {
        @apply bg-base-content/10 text-base-content/70;
    }
    .status-badge.locked {
        @apply bg-warning/20 text-warning;
    }
    
    /* IMPORTANT: Change to a more specific selector to avoid conflict */
    .initial-cloak[x-cloak] {
        display: none !important;
    }
    
    /* Highlight expanded rows for better visibility */
    .expanded-row {
        border-left: 4px solid #3b82f6;
    }
</style>

<script>
    document.addEventListener('alpine:init', () => {
        // Define the inputField component 
        Alpine.data('inputField', (id, label, model, name, placeholder) => ({
            id: id,
            name: name || model.toLowerCase(),
            model: model,
            placeholder: placeholder || `Enter ${label}`,
            showPassword: false
        }));
        
        Alpine.data('searchUI', () => ({
            speciesSearchTerm: '',
            dateRange: {
                start: '',
                end: ''
            },
            confidenceRange: {
                min: 0,
                max: 100
            },
            verifiedStatus: 'any',
            lockedStatus: 'any',
            timeOfDayFilter: 'any',
            formSubmitted: false,
            advancedFilters: false,
            isLoading: false,
            currentPage: 1,
            totalPages: 1,
            results: [],
            totalResults: 0,
            sortBy: 'date_desc',
            errorMessage: '',
            expanded: {},
            confidenceError: '',
            initializedPlayers: {}, // Track initialized players
            showTooltip: null, // Add missing property for tooltips
            
            // Form validation methods
            validateForm() {
                // Basic validation logic
                this.confidenceError = ''; // Reset error
                if (this.confidenceRange.min > this.confidenceRange.max) {
                    this.confidenceError = 'Minimum confidence cannot be greater than maximum confidence.';
                    return false;
                }
                return true;
            },
            
            // Form submission
            async submitSearch(page = 1) {
                if (!this.validateForm()) return;
                
                this.isLoading = true;
                this.errorMessage = '';
                this.currentPage = page;
                this.expanded = {}; // Reset expanded state when loading new results
                
                try {
                    // Build request body
                    const requestBody = {
                        species: this.speciesSearchTerm,
                        dateStart: this.dateRange.start,
                        dateEnd: this.dateRange.end,
                        confidenceMin: this.confidenceRange.min / 100,
                        confidenceMax: this.confidenceRange.max / 100,
                        verifiedStatus: this.verifiedStatus,
                        lockedStatus: this.lockedStatus,
                        timeOfDay: this.timeOfDayFilter,
                        page: this.currentPage,
                        sortBy: this.sortBy
                    };
                    
                    // Debug output for search parameters
                    console.log('Search parameters:', JSON.stringify(requestBody, null, 2));
                    console.log('timeOfDayFilter value:', this.timeOfDayFilter);
                    
                    const response = await fetch('/api/v2/search', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRF-Token': document.querySelector('meta[name=\'csrf-token\']').content
                        },
                        body: JSON.stringify(requestBody)
                    });
                    
                    if (!response.ok) {
                        throw new Error(`Server responded with ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.results = data.results || [];
                    this.totalResults = data.total || 0;
                    this.totalPages = data.pages || 1;
                    this.formSubmitted = true;
                } catch (error) {
                    console.error('Search error:', error);
                    this.errorMessage = `Search failed: ${error.message}`;
                    this.results = [];
                } finally {
                    this.isLoading = false;
                }
            },
            
            // Reset form
            resetForm() {
                this.speciesSearchTerm = '';
                this.dateRange.start = '';
                this.dateRange.end = '';
                this.confidenceRange.min = 0;
                this.confidenceRange.max = 100;
                this.verifiedStatus = 'any';
                this.lockedStatus = 'any';
                this.timeOfDayFilter = 'any';
                this.formSubmitted = false;
                this.results = [];
                this.errorMessage = '';
                this.expanded = {};
            },
            
            // Format date for display
            formatDate(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                return date.toLocaleString();
            },
            
            // Handle pagination
            goToPage(page) {
                if (page < 1 || page > this.totalPages) return;
                this.submitSearch(page);
            },
            
            // Handle sorting
            changeSort(sortOption) {
                this.sortBy = sortOption;
                this.submitSearch(1);
            },
            
            // Function to toggle expand state of a row
            toggleExpand(recordId) {
                console.log('Toggle expand clicked for ID:', recordId);
                
                // Pause audio if collapsing and currently playing
                if (this.expanded[recordId]) { // Check if it was expanded before toggling
                    const audioElement = document.getElementById(`audio-${recordId}`);
                    if (audioElement && !audioElement.paused) {
                        audioElement.pause();
                        console.log('Paused audio for collapsed row:', recordId);
                    }
                }

                // Use the spread operator for reactivity
                this.expanded = {
                    ...this.expanded, 
                    [recordId]: !this.expanded[recordId]
                };
                
                console.log('New expanded state:', JSON.stringify(this.expanded));
                
                // Force render on next tick
                this.$nextTick(() => {
                    // Initialize audio player when expanded
                    if (this.expanded[recordId]) {
                        this.initAudioPlayer(recordId);
                    }
                });
            },
            
            isExpanded(recordId) {
                return Boolean(this.expanded[recordId]);
            },
            
            // New method to initialize audio player
            initAudioPlayer(recordId) {
                console.log('Initializing audio player for ID:', recordId);
                
                // Prevent re-initialization
                if (this.initializedPlayers[recordId]) {
                    console.log('Audio player already initialized for ID:', recordId);
                    return;
                }
                
                const audioElement = document.getElementById(`audio-${recordId}`);
                const playPauseButton = document.getElementById(`playPause-${recordId}`);
                const progressBar = document.getElementById(`progress-${recordId}`);
                const progressIndicator = progressBar.querySelector('div');
                const currentTimeDisplay = document.getElementById(`currentTime-${recordId}`);
                const positionIndicator = document.getElementById(`position-indicator-${recordId}`);
                
                if (!audioElement || !playPauseButton || !progressBar || !currentTimeDisplay) {
                    console.error('Audio player elements not found');
                    return;
                }
                
                // Format time function
                const formatTime = (seconds) => {
                    const minutes = Math.floor(seconds / 60);
                    const remainingSeconds = Math.floor(seconds % 60);
                    return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
                };
                
                // Update progress function
                const updateProgress = () => {
                    if (!audioElement.duration) { return; }        // wait until metadata ready
                    const percent = (audioElement.currentTime / audioElement.duration) * 100;
                    progressIndicator.style.width = `${percent}%`;
                    currentTimeDisplay.textContent = formatTime(audioElement.currentTime);
                    
                    // Update position indicator
                    positionIndicator.style.left = `${percent}%`;
                    positionIndicator.style.opacity = 
                        (audioElement.currentTime === 0 || audioElement.currentTime === audioElement.duration) ? '0' : '0.7';
                };
                
                // Interval for updating progress
                let updateInterval;
                
                // Play/pause toggle
                const togglePlay = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (audioElement.paused) {
                        audioElement.play();
                    } else {
                        audioElement.pause();
                    }
                };
                
                // Add play button click handler
                playPauseButton.addEventListener('click', togglePlay);
                
                // Play event
                audioElement.addEventListener('play', () => {
                    playPauseButton.innerHTML = `
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    `;
                    updateInterval = setInterval(updateProgress, 100);
                });
                
                // Pause event
                audioElement.addEventListener('pause', () => {
                    playPauseButton.innerHTML = `
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    `;
                    clearInterval(updateInterval);
                });
                
                // End event
                audioElement.addEventListener('ended', () => {
                    clearInterval(updateInterval);
                    positionIndicator.style.opacity = '0';
                });
                
                // Add loadedmetadata event to update progress bar immediately when metadata is available
                audioElement.addEventListener('loadedmetadata', () => {
                    updateProgress();
                });
                
                // Progress bar click for seeking
                progressBar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const rect = progressBar.getBoundingClientRect();
                    const pos = (e.clientX - rect.left) / rect.width;
                    audioElement.currentTime = pos * audioElement.duration;
                    updateProgress();
                });
                
                // Seeking functionality for the spectrogram
                const spectrogramContainer = positionIndicator.closest('.audio-player-container');
                spectrogramContainer.addEventListener('click', (e) => {
                    // Only handle clicks directly on the spectrogram, not on controls
                    if (e.target === spectrogramContainer || e.target.tagName === 'IMG') {
                        const rect = spectrogramContainer.getBoundingClientRect();
                        const pos = (e.clientX - rect.left) / rect.width;
                        audioElement.currentTime = pos * audioElement.duration;
                        updateProgress();
                    }
                });
                
                // Initial update
                updateProgress();
                
                // Mark as initialized
                this.initializedPlayers[recordId] = true;
                console.log('Audio player successfully initialized for ID:', recordId);
            },

            // Updated method to play/pause audio from the main row button
            playAudioFromRow(recordId) {
                console.log('Play/Pause audio from row requested for:', recordId);

                if (this.isExpanded(recordId)) {
                    // Row is already expanded, toggle play/pause
                    console.log('Row already expanded, toggling play/pause for:', recordId);
                    const audioElement = document.getElementById(`audio-${recordId}`);
                    if (audioElement) {
                        if (!audioElement.paused) {
                            audioElement.pause();
                            console.log('Paused audio via row button:', recordId);
                        } else {
                            // Ensure player is initialized before playing again
                            this.initAudioPlayer(recordId);
                            audioElement.play().catch(e => console.error('Error playing audio:', e));
                            console.log('Played audio via row button:', recordId);
                        }
                    } else {
                        // Should ideally not happen if expanded, but handle it
                        console.warn('Audio element not found even though row is expanded:', recordId);
                        // Attempt to initialize and play
                        this.$nextTick(() => {
                            this.initAudioPlayer(recordId);
                            const newAudioElement = document.getElementById(`audio-${recordId}`);
                            if (newAudioElement) {
                                newAudioElement.play().catch(e => console.error('Error playing audio:', e));
                            }
                        });
                    }
                } else {
                    // Row not expanded, expand first and then play
                    console.log('Row not expanded, expanding and playing:', recordId);
                    this.toggleExpand(recordId); // This will call initAudioPlayer internally

                    // Use nextTick to ensure DOM update and player initialization before playing
                    this.$nextTick(() => {
                         const audioElement = document.getElementById(`audio-${recordId}`);
                         if (audioElement) {
                             // Small delay might be needed if initAudioPlayer is slow or async inside toggleExpand
                             setTimeout(() => { 
                                audioElement.play().catch(e => {
                                    console.error('Error playing audio after expand:', e);
                                });
                                console.log('Attempted to play audio after expand for:', recordId);
                             }, 50); // Adjust delay if necessary
                         } else {
                             console.error('Audio element not found after expand for:', recordId);
                         }
                    });
                }
            }
        }));
    });
    
    // Add this code to help debug click events
    document.addEventListener('DOMContentLoaded', () => {
        // Add global click listener to debug expand buttons
        document.addEventListener('click', (e) => {
            if (e.target.closest('.expand-btn')) {
                console.log('Expand button clicked via event delegation');
            }
        });
    });
</script>

{{end}}